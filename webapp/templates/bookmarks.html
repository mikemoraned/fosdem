{% extends "layout.html" %}
{%- import "components/bookmark.html" as bookmark -%}
{%- import "components/event.html" as event -%}
{%- import "components/external.html" as external -%}

{% block content %}
<section class="section hide-non-bookmarked">
    <div class="columns">
        <div class="column">
            <div class="buttons has-addons is-centered">
                <button class="button is-large is-responsive bookmark" id="export" disabled>
                    <span class="icon is-small">
                        <i class="fa-solid fa-upload"></i>
                    </span>
                    <span>Export</span>
                </button>
                <button class="button is-large is-responsive bookmark" id="import" disabled>
                    <span class="icon is-small">
                        <i class="fa-solid fa-download"></i>
                    </span>
                    <span>Import</span>
                </button>
            </div>
        </div>
    </div>
    <div class="columns" id="video-player-container" style="display: none;">
        <div class="column">
            <div class="box">
                <h5 class="title is-5"><i class="fa-solid fa-video"></i> Bookmarked Videos</h5>
                <video id="bookmarks-video" controls width="100%"></video>
                <p class="mt-2"><span id="video-current">0</span> / <span id="video-total">0</span></p>
            </div>
        </div>
    </div>
    {% for event in events %}
    <div class="columns" data-event-id="{{ event.id }}" data-bookmark-status="false">
        <div class="column">
            <div class="card" >
                {% call event::expandable_card_details(event) %}
                <footer class="card-footer">
                    {% call bookmark::bookmark_footer_item(event) %}
                    {% call external::sojourner_event(event) %}
                    {% call external::fosdem_event(event) %}
                </footer>
            </div>
        </div>
    </div>
    {% endfor %}
</section>

<dialog id="export-dialog">
    <div class="card">
        <header class="card-header">
            <p class="card-header-title">Export</p>
            <button class="card-header-icon copy">
                <span class="icon is-small">
                    <i class="fa-solid fa-upload"></i>
                </span>
            </button>
        </header>
        <div class="card-content">
            <textarea class="textarea is-info text" disabled></textarea>
        </div>
        <footer class="card-footer">
            <a href="#" class="card-footer-item copy">Copy</a>
            <a href="#" class="card-footer-item close">Close</a>
        </footer>
    </div>
</dialog>

<dialog id="import-dialog">
    <div class="card">
        <header class="card-header">
            <p class="card-header-title">Import</p>
            <button class="card-header-icon import">
                <span class="icon is-small">
                    <i class="fa-solid fa-download"></i>
                </span>
            </button>
        </header>
        <div class="card-content">
            <textarea class="textarea is-info text"></textarea>
        </div>
        <footer class="card-footer">
            <a href="#" class="card-footer-item import">Import</a>
            <a href="#" class="card-footer-item close">Close</a>
        </footer>
    </div>
</dialog>

{% endblock %}

{% block bookmarks_callbacks %}
<script type="module">
    import { bindExport, bindImport } from '/assets/bookmarks.js';

    function bindVideoPlayer(model) {
        const container = document.getElementById('video-player-container');
        const video = document.getElementById('bookmarks-video');
        const currentSpan = document.getElementById('video-current');
        const totalSpan = document.getElementById('video-total');

        let playlist = [];
        let currentIndex = 0;

        function updatePlaylist() {
            // Find video links in bookmarked events (document order)
            const bookmarkedEvents = document.querySelectorAll('[data-event-id][data-bookmark-status="true"]');
            playlist = [];
            bookmarkedEvents.forEach(event => {
                const videoLink = event.querySelector('a[data-type="video"]');
                if (videoLink) {
                    playlist.push(videoLink.href);
                }
            });

            totalSpan.textContent = playlist.length;

            if (playlist.length > 0) {
                container.style.display = '';
                if (currentIndex >= playlist.length) {
                    currentIndex = 0;
                }
                loadVideo(currentIndex);
            } else {
                container.style.display = 'none';
            }
        }

        function loadVideo(index) {
            if (index >= 0 && index < playlist.length) {
                currentIndex = index;
                video.src = playlist[index];
                currentSpan.textContent = index + 1;
            }
        }

        // Auto-advance on video end
        video.addEventListener('ended', () => {
            if (currentIndex < playlist.length - 1) {
                loadVideo(currentIndex + 1);
                video.play();
            }
        });

        // Update playlist when bookmarks change
        const observer = new MutationObserver(updatePlaylist);
        document.querySelectorAll('[data-event-id][data-bookmark-status]').forEach(el => {
            observer.observe(el, { attributes: true, attributeFilter: ['data-bookmark-status'] });
        });

        // Initial playlist build (after a small delay to let bookmark status settle)
        setTimeout(updatePlaylist, 100);
    }

    document.bookmarksCallbacks = [ bindExport, bindImport, bindVideoPlayer ];
</script>
{% endblock %}
