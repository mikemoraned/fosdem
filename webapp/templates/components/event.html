{%- import "bookmark.html" as bookmark -%}
{%- import "external.html" as external -%}

{% macro event_year(year) %}
<span class="icon-text">
    <span class="icon">
        <i class="fa-solid fa-calendar"></i>
    </span>
    <span>{{ year }}</span>
</span>
{% endmacro %}

{% macro card(event, related) %}
<div class="columns highlight-bookmarked">
    <div class="column">
        <div class="card" {% call event_attrs(event) %} {% call bookmark_attrs(event) %}>
            {% call expandable_card_details(event) %}
            <footer class="card-footer">
                {% call bookmark::bookmark_footer_item(event) %}
                {% call external::sojourner_event(event) %}
                {% call external::fosdem_event(event) %}
            </footer>
        </div>
    </div>
    <div class="column is-3">
        {% if related.is_some() %}
        {% let items = related.as_ref().unwrap() %}
        <div class="box">
            <h6 class="title is-6">
                <span class="icon-text">
                    <span class="icon">
                        <i class="fa-duotone fa-arrow-right-arrow-left"></i>
                    </span>
                    <span>Related:</span>
                </span>
            </h6>
            {% for year_group in items|group_items_by_year %}
            <div class="box">
                <div>
                    {% call event_year(year_group.year) %}
                </div>
                <ul>
                    {% for item in year_group.items %}
                    <li>
                        <a href="{{ item.event.id|event_url }}" {% call event_attrs(item.event) %} {% call
                            bookmark_attrs(item.event) %}>
                            <span
                                class="tag is-info">{{item.distance|distance_icon|safe}}&nbsp;{{item.distance|distance_similarity}}</span>
                            <span>"{{ item.event.title }}"</span>
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>

{% endmacro %}

{% macro card_header(event) %}
<div class="card-content">
    <p class="title is-5">
        <span>
            <i class="fa-duotone fa-calendar-clock"></i>&nbsp;<span data-event-title>"{{ event.title }}"</span> ({% call
            event_year(event.year) %})
        </span>
    </p>
    <p class="subtitle is-7">
        <span><i class="fa-solid fa-clock"></i> {{ event.date.format("%A") }} at {{ event.start.format("%H:%M") }}, {{
            event.duration }} minutes</span>,
        <a href="{{ event.nav_url(current_event) }}"><span><i class="fa-solid fa-location-dot"></i> {{ event.room
                }}</span></a>,
        <a href="/room/{{ event.room }}/#{{ event.date.format(" %a")|lower }}"><span><i
                    class="fa-solid fa-presentation-screen"></i> {{ event.room
                }}</span></a>,
        <span><i class="fa-regular fa-train-track"></i> {{ event.track }}</span>
        {% for presenter in event.presenters %}
        <span><i class="fa-regular fa-person-chalkboard"></i> {{ presenter.name }}</span>
        {% endfor %}
        {% if event.slides.len() > 0 %}
        , <a href="{{ event.slides[0] }}"><span><i class="fa-solid fa-presentation-screen"></i> slides</span></a>
        {% endif %}
        {% if event.has_video() %}
        , <span data-type="video"><i class="fa-solid fa-video"></i> video</span>
        {% endif %}
    </p>
</div>
{% endmacro %}

{% macro inline_video(event) %}
{% let videos = event.video_links() %}
{% if !videos.is_empty() %}
<details class="video-details">
    <summary><i class="fa-solid fa-video"></i> video</summary>
    <video controls preload="none">
        {% for video in videos %}
        {% if let Some(codecs) = video.codecs() %}
        <source src="{{ video.url() }}" type="{{ video.mime_type() }}; codecs=&quot;{{ codecs }}&quot;">
        {% else %}
        <source src="{{ video.url() }}" type="{{ video.mime_type() }}">
        {% endif %}
        {% endfor %}
    </video>
</details>
{% endif %}
{% endmacro %}

{% macro expandable_card_details(event) %}
<details class="event">
    <summary>{% call card_header(event) %}</summary>
    <div class="card-content">
        <div class="content">
            {{ event.abstract|safe }}
        </div>
        {% call inline_video(event) %}
    </div>
</details>
{% endmacro %}

{% macro event_attrs(event) %}
data-event-id="{{ event.id }}" data-has-video="{{ event.has_video() }}" data-event-url="{{ event.id|event_url }}"
{% endmacro %}

{% macro bookmark_attrs(event) %}
data-bookmark-status="false"
{% endmacro %}