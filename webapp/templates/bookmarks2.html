{% extends "layout.html" %}
{%- import "components/bookmark.html" as bookmark -%}
{%- import "components/event.html" as event -%}
{%- import "components/external.html" as external -%}

{% block content %}
<section class="section">
    <div class="container is-fluid">
        <h1 class="title">Bookmarked Events - {{ current_fosdem.year }}</h1>

        {% for timetable in timetables %}
        <div class="box">
            <h2 class="subtitle">{{ timetable.day_name }} - {{ timetable.date }}</h2>

            <div class="table-container">
                <table class="table is-bordered is-striped is-narrow is-hoverable is-fullwidth">
                    <thead>
                        <tr>
                            <th>Time</th>
                            {% for room in timetable.rooms %}
                            <th style="writing-mode: vertical-rl;">
                                {{ room }}
                            </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in timetable.rows %}
                        <tr>
                            <td>{{ row.time_slot.format("%H:%M") }}</td>
                            {% for cell in row.cells %}
                            {% match cell %}
                            {% when Some with (c) %}
                            <td rowspan="{{ c.rowspan }}"
                                data-event-id="{{ c.event.id }}"
                                data-bookmark-status="false"
                                class="event-cell"
                                title="{{ c.event.title }}"
                                style="vertical-align: middle; text-align: left; padding: 0.5rem; overflow: hidden; cursor: pointer; writing-mode: vertical-rl; white-space: nowrap; text-overflow: ellipsis; background-color: #3e8ed0; color: white;">
                                {{ c.event.title }}
                                <div class="event-detail-content" style="display: none;">
                                    <div class="card">
                                        {% call event::expandable_card_details(c.event) %}
                                        <footer class="card-footer">
                                            {% call bookmark::bookmark_footer_item(c.event) %}
                                            {% call external::sojourner_event(c.event) %}
                                            {% call external::fosdem_event(c.event) %}
                                        </footer>
                                    </div>
                                </div>
                            </td>
                            {% when None %}
                            {% endmatch %}
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endfor %}
    </div>
</section>

<dialog id="event-detail-dialog">
    <div style="max-width: 800px; background: white; border-radius: 6px; padding: 1rem;">
        <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
            <button class="delete close-dialog" aria-label="close"></button>
        </div>
        <div id="event-detail-container">
        </div>
    </div>
</dialog>

{% endblock %}

{% block bookmarks_callbacks %}
<script type="module">
    // Note: Not using bindExport/bindImport from bookmarks.js since we don't have those buttons in this view
    document.bookmarksCallbacks = [];

    // Handle event detail dialog
    const dialog = document.getElementById('event-detail-dialog');
    const container = document.getElementById('event-detail-container');

    // Open dialog when event cell is clicked
    document.querySelectorAll('.event-cell').forEach(cell => {
        cell.addEventListener('click', (e) => {
            e.preventDefault();
            const eventContent = cell.querySelector('.event-detail-content');

            if (eventContent) {
                // Clone the content to avoid moving it from the original location
                const clone = eventContent.cloneNode(true);
                clone.style.display = 'block';
                container.innerHTML = '';
                container.appendChild(clone);
                dialog.showModal();
            }
        });
    });

    // Close dialog
    document.querySelectorAll('.close-dialog').forEach(button => {
        button.addEventListener('click', (e) => {
            e.preventDefault();
            dialog.close();
        });
    });

    // Close on backdrop click
    dialog.addEventListener('click', (e) => {
        if (e.target === dialog) {
            dialog.close();
        }
    });
</script>
{% endblock %}